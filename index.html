<!-- index.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TrueMan Diagnostics</title>
  <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
  <link rel="shortcut icon" href="/assets/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Diagnostics" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" defer></script>
  <script src="./assets/js/app.js" defer></script>
  <link href="./assets/css/style.css" rel="stylesheet">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('Service Worker registered with scope:', reg.scope))
        .catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>
</head>
<body>

<!-- Main Layout Hidden Initially -->
<div id="mainLayout" style="display:none;">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">TrueMan Diagnostics</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="#" id="dashboardTab">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="consoleTab">Console</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="controlTab">Control</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="modbusDropdown" role="button" data-bs-toggle="dropdown">Modbus Devices</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item modbus-tab" href="#" data-page="bldc1">BLDC1</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="bldc2">BLDC2</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="bldc3">BLDC3</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="controller">Controller</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="brush1">Brush1</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="brush2">Brush2</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="stepper1">Stepper1</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="stepper2">Stepper2</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="linak1">Linak1</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="linak2">Linak2</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="hopper">Hopper</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="elevator">Elevator</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="eleboard">EleBoard</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="ledserver">LedServer</a></li>
              <li><a class="dropdown-item modbus-tab" href="#" data-page="ledpanel11">LedPanel11</a></li>
            </ul>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <button id="disconnectBtnNav" class="btn btn-danger ms-2">Disconnect</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container py-4" id="appContent"></div>
</div>

<!-- Connect Layout -->
<div class="container py-5" id="connectLayout"></div>

<!-- Toast -->
<div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
  <div id="bleToast" class="toast bg-success text-white" role="alert" data-bs-delay="3000">
    <div class="toast-body">âœ… ACK received!</div>
  </div>
</div>

<!-- Floating Theme Toggle Button -->
<button id="floatingThemeToggle" type="button"
        class="btn btn-light shadow position-fixed"
        style="bottom: 1rem; right: 1rem; z-index: 9999;"
        aria-label="Toggle theme" title="Toggle light/dark">
  <i id="floatingThemeIcon" class="bi bi-sun-fill"></i>
</button>

<!-- Theme Script -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const root = document.documentElement;
    const btn = document.getElementById('floatingThemeToggle');
    const icon = document.getElementById('floatingThemeIcon');
    const storageKey = 'theme';
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

    const saved = localStorage.getItem(storageKey);
    const initial = (saved === 'dark' || saved === 'light')
      ? saved
      : (prefersDark.matches ? 'dark' : 'light');
    root.setAttribute('data-bs-theme', initial);
    updateUI();

    if (btn) {
      btn.addEventListener('click', () => {
        const next = root.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-bs-theme', next);
        localStorage.setItem(storageKey, next);
        root.classList.add('theme-animate');
        updateUI();
        clearTimeout(window.__themeAnimTO);
        window.__themeAnimTO = setTimeout(() => {
          root.classList.remove('theme-animate');
        }, 300);
      });
    }

    prefersDark.addEventListener?.('change', e => {
      if (!localStorage.getItem(storageKey)) {
        root.setAttribute('data-bs-theme', e.matches ? 'dark' : 'light');
        updateUI();
      }
    });

    function updateUI() {
      console.log("[updateUI] running...");
      window.updateUI = updateUI;

      const theme = root.getAttribute('data-bs-theme');
      const meta = document.querySelector('meta[name="theme-color"]');
      if (meta) {
        const color = getComputedStyle(root).getPropertyValue('--bs-primary').trim();
        if (color) meta.setAttribute('content', color);
      }

      if (btn && icon) {
        btn.classList.toggle('btn-dark', theme === 'dark');
        btn.classList.toggle('btn-light', theme !== 'dark');
        icon.className = theme === 'dark' ? 'bi bi-moon-fill' : 'bi bi-sun-fill';
      }

      const logo = document.getElementById('logoImg');
      if (logo) {
        logo.src = theme === 'dark'
          ? './assets/TrueManLogoDark.jpg'
          : './assets/TrueManLogo.jpg';
      }
    }
  });
</script>
</body>
</html>
